# Дизайн мультикомандных трейдов

## 1. Структура данных

### Backend Request Model
```python
class MultiTeamTradeRequest(BaseModel):
    trades: List[TeamTrade]  # Список команд и их трейдов
    period: str = "2026_total"
    punt_categories: List[str] = []
    exclude_ir: bool = False

class TeamTrade(BaseModel):
    team_id: int
    give: List[str]  # Имена игроков, которых отдает команда
    receive: List[str]  # Имена игроков, которых получает команда
```

### Пример запроса:
```json
{
  "trades": [
    {
      "team_id": 1,
      "give": ["Player A", "Player B"],
      "receive": ["Player C"]
    },
    {
      "team_id": 2,
      "give": ["Player C"],
      "receive": ["Player A"]
    },
    {
      "team_id": 3,
      "give": [],
      "receive": ["Player B"]
    }
  ],
  "period": "2026_total",
  "punt_categories": [],
  "exclude_ir": false
}
```

## 2. Алгоритм расчета

### Шаг 1: Валидация
- Проверить, что все игроки в `give` уникальны
- Проверить, что все игроки в `receive` уникальны
- Проверить баланс: сумма всех `give` = сумма всех `receive`
- Проверить, что игрок не может быть и в `give` и в `receive` одной команды

### Шаг 2: Создание маппинга перемещений
```python
# Создаем словарь: player_name -> new_team_id
player_movements = {}
for trade in trades:
    for player_name in trade.give:
        # Находим, какая команда получает этого игрока
        receiving_team = find_receiving_team(player_name, trades)
        player_movements[player_name] = receiving_team.team_id
```

### Шаг 3: Расчет ДО трейда
Для каждой команды:
- Получить всех игроков команды
- Рассчитать Total Z, категории, raw stats

### Шаг 4: Расчет ПОСЛЕ трейда
Для каждой команды:
- Взять всех игроков команды
- Применить перемещения (изменить team_id)
- Рассчитать Total Z, категории, raw stats

### Шаг 5: Симуляция мест
- Рассчитать места ДО для всех команд
- Рассчитать места ПОСЛЕ для всех команд
- Вычислить изменение места для каждой команды

## 3. Структура ответа

```python
{
  "teams": [
    {
      "team_id": 1,
      "team_name": "Team A",
      "before": {
        "total_z": 45.2,
        "categories": {...},
        "raw_categories": {...}
      },
      "after": {
        "total_z": 48.5,
        "categories": {...},
        "raw_categories": {...}
      },
      "delta": 3.3,
      "players_given": ["Player A", "Player B"],
      "players_received": ["Player C"]
    },
    ...
  ],
  "simulation_ranks": {
    "z_scores": {
      "team_1": {"before": 3, "after": 2, "delta": -1},
      "team_2": {"before": 5, "after": 6, "delta": 1},
      ...
    },
    "team_stats_avg": {...}
  },
  "validation": {
    "is_valid": true,
    "errors": []
  }
}
```

## 4. UI/UX дизайн

### Вариант A: Пошаговый (рекомендуется)
1. **Шаг 1: Выбор команд**
   - Кнопка "Добавить команду"
   - Для каждой команды: выбор из списка

2. **Шаг 2: Настройка трейдов**
   - Для каждой команды:
     - Список игроков команды
     - Чекбоксы "Отдает" и "Получает"
     - Визуальное разделение

3. **Шаг 3: Результаты**
   - Таблица/карточки для каждой команды
   - Сравнение до/после
   - Изменение места в симуляции

### Вариант B: Компактный
- Все команды на одной странице
- Вертикальные колонки для каждой команды
- Горизонтальная прокрутка при большом количестве команд

## 5. Визуализация результатов

### Для каждой команды:
- Карточка с:
  - Название команды
  - Total Z: до → после (Δ)
  - Изменение места: до → после (Δ)
  - Список игроков: отдано / получено
  - Детализация по категориям (таблица)

### Общий вид:
- Сводная таблица всех команд
- График изменения Total Z
- График изменения мест

## 6. Особые случаи

### 3+ команды
- Поддержка любого количества команд
- Валидация баланса для всех команд

### Несбалансированный трейд
- Предупреждение, если сумма отданных ≠ сумма полученных
- Возможность добавить "пустые слоты" для баланса

### Циклические трейды
- Team A → Team B → Team C → Team A
- Все должно работать корректно

## 7. Реализация

### Backend (`/api/multi-team-trade-analysis`)
1. Валидация запроса
2. Создание маппинга перемещений
3. Расчет для каждой команды (до/после)
4. Симуляция мест
5. Формирование ответа

### Frontend
1. Компонент `MultiTeamTradeAnalyzer`
2. Динамическое добавление/удаление команд
3. Выбор игроков для каждой команды
4. Отображение результатов

## 8. Примеры использования

### Простой 3-командный трейд:
- Team A отдает Player 1, получает Player 2
- Team B отдает Player 2, получает Player 3
- Team C отдает Player 3, получает Player 1

### Сложный трейд:
- Team A отдает [P1, P2], получает [P3]
- Team B отдает [P3, P4], получает [P1, P5]
- Team C отдает [P5], получает [P2, P4]

